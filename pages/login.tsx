import React, { useState, useEffect } from 'react'
import Head from 'next/head'
import Link from 'next/link'
import { useRouter } from 'next/router';
import { useSetRecoilState } from 'recoil'
import { getAuth, GoogleAuthProvider, signInWithEmailAndPassword, signInWithPopup } from 'firebase/auth';

import { FormLabel, Divider } from '@mui/material';
import { styled } from '@mui/system';

import styles from '../styles/login.module.css'
import { firebaseApp } from '../firestore/firebase';
import { userAuthState } from '../state/userAuthState';
import FormHeader from '../components/organisms/header/FormHeader'
import { MyMuiSquareButton } from '../components/atoms/buttons/MyMuiSquareButton';
import { TextField } from '../components/atoms/MyMuiTextField';


const MyFormLabel = styled(FormLabel)({
  display:"block",
  fontWeight:"bold",
  paddingBottom:"4px",
})

const MyDivider = styled(Divider)({
  marginBottom:"10px",
})

const Login = () => {
  const router = useRouter();
  const auth = getAuth(firebaseApp)

  const [error, setError] = useState("")
  const setUserAuth = useSetRecoilState(userAuthState)

  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");

  useEffect(() => {
    if(auth.currentUser){
      console.log("auth.currentUser",auth.currentUser)
      router.push("/")
    } else {
      console.log("auth.currentUser",auth.currentUser)
      return
    }
  // eslint-disable-next-line react-hooks/exhaustive-deps
  },[]);

  const handleEmailChange = (e: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>) => {
    setEmail(e.target.value)
  }
  const handlePasswordChange = (e: React.ChangeEvent<HTMLTextAreaElement | HTMLInputElement>) => {
    setPassword(e.target.value)
  }
  // emailでログインするための関数
  const handleEmailLogin = async(e: any) => {
    e.preventDefault();
    console.log(email, password)
    signInWithEmailAndPassword(auth, email, password)
    .then((user) => {
      setUserAuth(user.user.uid !== "")
      router.push("/")
      console.log('ログイン成功=', user.user.uid)
    })
    .catch((error) => {
      switch (error.code) {
        case 'auth/invalid-email':
          setError('正しいメールアドレスの形式で入力してください。');
          break;
        case 'auth/user-not-found':
          setError('メールアドレスかパスワードに誤りがあります。');
          break;
        case 'auth/wrong-password':
          setError('メールアドレスかパスワードに誤りがあります。');
          break;
        default:
          setError('メールアドレスかパスワードに誤りがあります。');
          break;
      }
    });
  };

  // googleアカウントでログインするための関数
  const handleGoogleLogin = async(e: any) => {
    e.preventDefault();
    const provider = new GoogleAuthProvider();
    signInWithPopup(auth, provider)
    .then((result) => {
      setUserAuth(result.user.uid !== "")
      router.push("/")
      console.log('ログイン成功=', result.user.uid)
    }).catch((error) => {
      switch (error.code) {
        case 'error.customData.email':
          setError('そのメールアドレスは既に使用されています。');
          break;
      }
    });
  };

  return (
    <>
      <Head>
        <title>ログイン</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/VPhotoIcon2.ico" />
      </Head>
      <FormHeader />
      <div className={styles.login}>
        <div className={styles.title_text_area}>
          <text className={styles.title_text}>
            ログイン
          </text>
        </div>
        <form>
          
          <div className={styles.email_area}>
            <MyFormLabel>Email address</MyFormLabel>
            <TextField
              placeholder='Email address' 
              variant="outlined" 
              size='small' 
              fullWidth={true}
              onChange={(e)=> handleEmailChange(e)}
            />
          </div>
          <div className={styles.password_area}>
            <MyFormLabel>Password</MyFormLabel>
            <TextField
              placeholder="Password" 
              variant="outlined" 
              size='small' 
              fullWidth={true}
              onChange={(e) => handlePasswordChange(e)}
            />
          </div>
 
          <MyMuiSquareButton
            variant="contained" 
            fullWidth={true} 
            onClick={handleEmailLogin}
          >
            ログイン
          </MyMuiSquareButton>

        </form>
        <div  className={styles.signup_link_area}>
          ユーザー登録は
            <Link href={"/signup"} style={{textDecoration:"none"}}>
              <span className={styles.signup_link}>
                こちら
              </span>
            </Link>
          から
        </div>
        <MyDivider>または</MyDivider>
        <MyMuiSquareButton 
          variant="contained" 
          onClick={handleGoogleLogin}  
          fullWidth={true}
        >
          Googleでログイン
        </MyMuiSquareButton>

      </div>
    </>
  )
}

export default Login;